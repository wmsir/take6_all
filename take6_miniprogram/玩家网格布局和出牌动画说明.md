# 玩家网格布局和出牌动画说明

## 功能概述

本次更新重新设计了玩家列表布局和出牌展示流程，主要实现：
1. 玩家列表改为 **2行5列网格布局**（最多10个玩家）
2. 卡牌显示在 **玩家名称和头像右侧**
3. 玩家出牌后先显示 **卡牌背面** 🂠
4. 所有玩家出完后，卡牌 **翻转显示正面**
5. 结算后，卡牌从玩家位置 **移动到场牌区域**（带动画）

---

## 1. 玩家网格布局（2行5列）

### 布局结构
```
┌─────────┬─────────┬─────────┬─────────┬─────────┐
│ 玩家1   │ 玩家2   │ 玩家3   │ 玩家4   │ 玩家5   │
│ 头像+名 │ 头像+名 │ 头像+名 │ 头像+名 │ 头像+名 │
│ [卡牌]  │ [卡牌]  │ [卡牌]  │ [卡牌]  │ [卡牌]  │
├─────────┼─────────┼─────────┼─────────┼─────────┤
│ 玩家6   │ 玩家7   │ 玩家8   │ 玩家9   │ 玩家10  │
│ 头像+名 │ 头像+名 │ 头像+名 │ 头像+名 │ 头像+名 │
│ [卡牌]  │ [卡牌]  │ [卡牌]  │ [卡牌]  │ [卡牌]  │
└─────────┴─────────┴─────────┴─────────┴─────────┘
```

### 实现位置
- **WXML**：`pages/game/game.wxml` 第18-47行
- **WXSS**：`pages/game/game.wxss` 第78-188行
- **JS**：`pages/game/game.js` 第463行（空位计算）

### CSS 关键属性
```css
.players-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);  /* 5列 */
  grid-template-rows: repeat(2, auto);     /* 2行 */
  gap: 12rpx;
}
```

### 自适应规则
- 玩家数 < 10：自动填充空位（显示"等待加入"）
- 每个格子最小高度：100rpx
- 响应式：在不同屏幕宽度下自动调整格子大小

---

## 2. 卡牌显示在右侧

### 布局设计
每个玩家格子分为两部分：
- **左侧**：头像（48rpx圆形）+ 名称 + 状态 + 分数
- **右侧**：出牌区域（56rpx × 80rpx）

### WXML 结构
```xml
<view class="player-grid-item">
  <!-- 左侧：玩家信息 -->
  <view class="player-info-left">
    <image class="player-avatar" src="{{item.avatarUrl}}"></image>
    <view class="player-details">
      <text class="player-name">{{item.displayName}}</text>
      <text class="player-status">{{item.statusText}}</text>
      <text class="player-score">🐂 {{item.score}}</text>
    </view>
  </view>
  
  <!-- 右侧：出牌区域 -->
  <view class="player-card-area">
    <!-- 卡牌背面/正面 -->
  </view>
</view>
```

---

## 3. 出牌流程和动画

### 流程图
```
玩家出牌
   ↓
显示卡牌背面 🂠
   ↓
等待其他玩家...
   ↓
所有人出完 → 翻转显示正面
   ↓
服务器结算
   ↓
卡牌移动到场牌区域（2秒动画）
   ↓
清空玩家卡牌，准备下一回合
```

### 3.1 卡牌背面显示

**触发条件**：
- `player.hasPlayed === true`（玩家已出牌）
- `allPlayersPlayed === false`（还有玩家未出牌）

**WXML 逻辑**：
```xml
<view class="card-back" wx:if="{{item.hasPlayed && !allPlayersPlayed}}">
  <text class="card-back-icon">🂠</text>
</view>
```

**样式特点**：
- 蓝色渐变背景
- 扑克牌背面图标
- 0.3秒弹出动画

**CSS**：
```css
.card-back {
  background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
  animation: cardBackShow 0.3s ease-out;
}
```

### 3.2 卡牌正面显示（翻转）

**触发条件**：
- `player.playedCard !== null`（有已出的牌）
- `allPlayersPlayed === true`（所有玩家都出完了）

**WXML 逻辑**：
```xml
<view class="card-front" wx:if="{{item.playedCard && allPlayersPlayed}}">
  <text class="card-number">{{item.playedCard.number}}</text>
  <text class="card-bull">{{item.playedCard.bullheads}}🐂</text>
</view>
```

**翻转动画**：
```css
@keyframes cardFlipShow {
  0% {
    opacity: 0;
    transform: rotateY(90deg) scale(0.8);
  }
  100% {
    opacity: 1;
    transform: rotateY(0) scale(1);
  }
}
```

### 3.3 卡牌移动到场牌区域

**触发方式**：服务器推送 WebSocket 消息
```javascript
{
  type: 'cardsPlaced',  // 或 'roundSettlement'
  data: { ... }
}
```

**前端处理**：
```javascript
// pages/game/game.js 第287-293行
else if (msg.type === 'cardsPlaced' || msg.type === 'roundSettlement') {
  console.log('[GAME] 收到卡牌放置通知，开始移动动画');
  this.startCardMoveAnimation();
}
```

**移动动画逻辑**：
1. 设置 `player.isAnimating = true`
2. WXML 添加 `card-moving` class
3. CSS 动画持续 2 秒
4. 动画结束后清空 `playedCard`，重置状态

**移动动画效果**：
```css
@keyframes cardMoveToBoard {
  0% {
    opacity: 1;
    transform: translate(0, 0) scale(1);
  }
  50% {
    opacity: 0.8;
    transform: translate(100rpx, 200rpx) scale(0.8);
  }
  100% {
    opacity: 0;
    transform: translate(200rpx, 400rpx) scale(0.5);
  }
}
```

---

## 4. 关键数据字段

### data 新增字段
```javascript
{
  allPlayersPlayed: false,  // 所有玩家是否都出完牌
  emptySlots: []            // 空位数组（用于填充到10个位置）
}
```

### players 数组字段
```javascript
players: [
  {
    id: 'player1',
    displayName: '张三',
    avatarUrl: '/images/avatar.png',
    score: 5,
    status: 'played',        // 'thinking' | 'played' | 'locked'
    statusText: '已出牌',
    hasPlayed: true,         // 是否已出牌
    playedCard: {            // 已出的牌（所有人出完后才有）
      number: 45,
      bullheads: 5
    },
    isAnimating: false,      // 是否正在播放移动动画
    animationStyle: ''       // 动画样式（保留字段）
  }
]
```

---

## 5. 后端对接要点

### 5.1 判断所有玩家出完牌

**前端逻辑**：
```javascript
const allPlayersPlayed = players.length > 0 && players.every(p => p.hasPlayed);
```

**后端需提供**：
- 每个玩家的 `hasPlayed` 字段（boolean）
- 当所有玩家都出完时，推送 `roomStateUpdate` 并确保 `playedCardsThisTurn` 包含所有玩家的牌

### 5.2 触发翻牌

**自动触发**：
- 前端检测到 `allPlayersPlayed` 从 `false` 变为 `true` 时
- 自动调用 `startCardFlipAnimation()`
- 500ms 后显示正面（通过 WXML 的 `wx:if` 自动切换）

### 5.3 触发移动动画

**后端推送消息**：
```javascript
{
  type: 'cardsPlaced',  // 推荐使用这个类型
  data: {
    placedCards: [
      { playerId: 'player1', cardNumber: 45, rowIndex: 2 },
      { playerId: 'player2', cardNumber: 67, rowIndex: 3 }
    ]
  }
}
```

**或者**：
```javascript
{
  type: 'roundSettlement',
  data: {
    // 结算数据
  }
}
```

**前端响应**：
- 接收到消息后调用 `startCardMoveAnimation()`
- 2秒后自动清空所有玩家的 `playedCard`
- 重置 `allPlayersPlayed = false`

### 5.4 下一回合准备

**后端推送**：
```javascript
{
  type: 'roomStateUpdate',
  roomState: {
    currentTurnNumber: 2,  // 回合数+1
    playedCardsThisTurn: {},  // 清空已出牌
    players: {
      'player1': { hasPlayed: false, ... },  // 重置 hasPlayed
      'player2': { hasPlayed: false, ... }
    }
  }
}
```

---

## 6. 动画时间线

```
T=0s    玩家A出牌 → 显示卡牌背面
T=1s    玩家B出牌 → 显示卡牌背面
T=2s    玩家C出牌 → 显示卡牌背面
...
T=5s    所有人出完 → 0.5秒翻转动画 → 显示正面
T=6s    服务器结算完成 → 推送 cardsPlaced
T=6s    开始移动动画（2秒）
T=8s    动画结束，清空卡牌，准备下一回合
```

---

## 7. 样式细节

### 玩家格子
- 背景：半透明深色 `rgba(30, 41, 59, 0.6)`
- 边框：1rpx 灰色
- 圆角：16rpx
- 内边距：12rpx
- 最小高度：100rpx

### 头像
- 尺寸：48rpx × 48rpx
- 圆形：`border-radius: 50%`
- 蓝色边框：2rpx

### 卡牌背面
- 尺寸：56rpx × 80rpx
- 蓝色渐变背景
- 扑克牌图标：🂠

### 卡牌正面
- 尺寸：56rpx × 80rpx
- 深色渐变背景
- 蓝色边框
- 显示：数字 + 牛头数

### 状态标签
- "思考中"：黄色背景 `rgba(251, 191, 36, 0.2)`
- "已出牌"：绿色背景 `rgba(16, 185, 129, 0.2)`
- "已锁定"：绿色背景（同上）

---

## 8. 测试要点

### 8.1 布局测试
- ✅ 2-10个玩家时网格正确显示
- ✅ 少于10人时空位正确填充
- ✅ 玩家信息正确显示（头像、名称、分数、状态）
- ✅ 响应式：在不同屏幕宽度下正常显示

### 8.2 出牌流程测试
- ✅ 玩家出牌后立即显示卡牌背面
- ✅ 其他玩家看到的是背面
- ✅ 所有人出完后自动翻转显示正面
- ✅ 正面显示正确的数字和牛头数

### 8.3 动画测试
- ✅ 卡牌背面弹出动画流畅（0.3秒）
- ✅ 卡牌翻转动画流畅（0.5秒）
- ✅ 卡牌移动动画流畅（2秒）
- ✅ 动画结束后卡牌正确清空

### 8.4 状态同步测试
- ✅ `allPlayersPlayed` 状态正确更新
- ✅ `hasPlayed` 状态正确同步
- ✅ `playedCard` 数据正确显示
- ✅ 下一回合状态正确重置

---

## 9. 代码位置清单

### WXML (pages/game/game.wxml)
- 第18-47行：玩家网格布局
- 第30-43行：卡牌显示逻辑（背面/正面切换）

### JS (pages/game/game.js)
- 第40-42行：data 新增字段
- 第412行：判断 `allPlayersPlayed`
- 第454-457行：玩家字段赋值（`hasPlayed`, `isAnimating`）
- 第463行：计算空位 `emptySlots`
- 第569-570行：设置 `allPlayersPlayed` 和 `emptySlots`
- 第573-579行：触发翻牌动画
- 第767-773行：`startCardFlipAnimation()` 函数
- 第775-801行：`startCardMoveAnimation()` 函数
- 第287-293行：监听 `cardsPlaced` 消息

### WXSS (pages/game/game.wxss)
- 第78-188行：玩家网格布局样式
- 第128-141行：卡牌背面样式
- 第143-155行：卡牌背面弹出动画
- 第158-173行：卡牌正面样式
- 第175-182行：卡牌翻转动画
- 第184-198行：卡牌移动动画

---

## 10. 性能优化建议

1. **减少重绘**：只在必要时更新 `players` 数组
2. **动画优化**：使用 `transform` 和 `opacity`（GPU加速）
3. **内存管理**：动画结束后及时清空数据
4. **防抖处理**：避免短时间内多次触发动画
5. **条件渲染**：使用 `wx:if` 减少不必要的节点

---

## 11. 后续优化方向

1. **个性化动画**：根据卡牌数值调整移动轨迹
2. **音效**：翻牌音效、移动音效
3. **震动反馈**：翻牌时震动提醒
4. **粒子效果**：卡牌移动时添加光效
5. **慢动作回放**：可选择慢速播放动画
6. **玩家排序**：当前玩家固定在第一行第一个位置
7. **空位交互**：点击空位邀请好友
8. **卡牌预览**：长按卡牌查看详情

---

## 12. 常见问题

### Q1：为什么卡牌背面没有显示？
**A**：检查 `player.hasPlayed` 是否为 `true`，以及 `allPlayersPlayed` 是否为 `false`。

### Q2：为什么所有人出完了还是显示背面？
**A**：检查 `allPlayersPlayed` 的计算逻辑，确保所有玩家的 `hasPlayed` 都为 `true`。

### Q3：卡牌移动动画没有触发？
**A**：确保后端推送了 `cardsPlaced` 或 `roundSettlement` 消息，并检查前端监听逻辑。

### Q4：动画播放后卡牌没有清空？
**A**：检查 `startCardMoveAnimation()` 中的 `setTimeout` 是否正常执行（2秒后清空）。

### Q5：玩家数量少于10个时布局混乱？
**A**：检查 `emptySlots` 的计算是否正确，应该是 `10 - players.length`。

---

## 13. 兼容性说明

- ✅ 支持微信小程序基础库 2.0+
- ✅ 支持 iOS 和 Android
- ✅ 使用 CSS Grid 布局（基础库 2.2.3+）
- ✅ 使用 CSS 动画（兼容性良好）
- ✅ 支持不同屏幕尺寸（iPhone SE 到 iPad）

---

## 总结

本次更新实现了完整的玩家网格布局和出牌动画流程，UI体验大幅提升：
- **2行5列网格**：最多支持10个玩家
- **卡牌右侧显示**：清晰展示每个玩家的出牌状态
- **渐进式动画**：背面 → 正面 → 移动，流程清晰
- **自动化处理**：前端自动检测状态并触发动画
- **后端简单**：只需推送标准消息，无需额外逻辑

所有动画均已实现并优化，提供流畅的用户体验！🎉

