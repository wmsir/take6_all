<!-- å¯¹å±€é¡µé¢ -->
<view class="container">
  <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
  <view class="header">
    <view class="header-left">
      <text class="round-info">ç¬¬{{currentRound}}å±€ãƒ»å›åˆ{{currentTurn}}/10</text>
      <text class="score-info">å½“å‰çŒªå¤´ï¼šä½ <text class="my-score">{{myScore}}</text>Â·{{otherScores}}</text>
    </view>
    <view class="header-right">
      <view class="countdown-section">
        <text class="countdown-label">å€’è®¡æ—¶</text>
        <text class="countdown-value">{{countdown}}s</text>
      </view>
      <button class="settings-btn" bindtap="handleSettings">âš™</button>
    </view>
  </view>

  <!-- ç©å®¶ç½‘æ ¼å¸ƒå±€ï¼ˆ2è¡Œ5åˆ—ï¼‰ -->
  <view class="players-grid">
    <view class="player-grid-item" wx:for="{{players}}" wx:key="sessionId" data-player-id="{{item.id || item.userId}}">
      <view class="player-info-left">
        <image class="player-avatar" src="{{item.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
        <view class="player-details">
          <view class="player-name-row">
            <text class="player-name">{{item.displayName || item.nickname}}</text>
            <text class="player-status {{item.status}}">{{item.statusText}}</text>
          </view>
          <text class="player-score">ğŸ‚ {{item.score || 0}}</text>
        </view>
      </view>
      
      <!-- å³ä¾§å‡ºç‰ŒåŒºåŸŸ -->
      <view class="player-card-area">
        <!-- æ˜¾ç¤ºå¡ç‰ŒèƒŒé¢ï¼ˆå·²å‡ºç‰Œä½†æœªå…¨éƒ¨å‡ºå®Œï¼‰ -->
        <view class="card-back" wx:if="{{item.hasPlayed && !allPlayersPlayed}}">
          <text class="card-back-icon">ğŸ‚ </text>
        </view>
        <!-- æ˜¾ç¤ºå¡ç‰Œæ­£é¢ï¼ˆæ‰€æœ‰äººéƒ½å‡ºå®Œäº†ï¼‰ -->
        <view class="card-front {{item.isAnimating ? 'card-moving' : ''}}" wx:if="{{item.playedCard && allPlayersPlayed}}" style="{{item.animationStyle}}">
          <text class="card-number">{{item.playedCard.number}}</text>
          <text class="card-bull" wx:if="{{item.playedCard.bullheads > 0}}">{{item.playedCard.bullheads}}ğŸ‚</text>
        </view>
      </view>
    </view>
    
    <!-- å¡«å……ç©ºä½ï¼ˆç¡®ä¿2è¡Œ5åˆ—ï¼Œå…±10ä¸ªä½ç½®ï¼‰ -->
    <view class="player-grid-item empty" wx:for="{{emptySlots}}" wx:key="index">
      <view class="empty-slot">
        <text class="empty-text">ç­‰å¾…åŠ å…¥</text>
      </view>
    </view>
  </view>

  <!-- åœºç‰ŒåŒºåŸŸ -->
  <view class="board-section">
    <view class="board-card">
      <view class="rows-list">
        <view class="row-item" wx:for="{{rows}}" wx:key="index">
          <view class="row-left">
            <text class="row-number">{{index + 1}}</text>
            <view class="row-cards">
              <view class="board-card-item {{card.isHead ? 'head' : ''}} {{card.isDanger ? 'danger' : ''}} {{card.isFifth ? 'fifth' : ''}}" 
                    wx:for="{{item.cards}}" 
                    wx:for-item="card" 
                    wx:key="number">
                <text wx:if="{{card.isHead}}" class="card-label">æ’å¤´</text>
                <text wx:if="{{card.isFifth}}" class="card-label fifth">ç¬¬5å¼ </text>
                <text class="card-number">{{card.number}}</text>
                <text wx:if="{{card.bullheads > 0}}" class="card-bullheads">{{card.bullheads}} ğŸ‚</text>
              </view>
            </view>
          </view>
          <view class="row-right">
            <text class="row-bullheads {{item.isDanger ? 'danger' : ''}}">ğŸ‚ {{item.totalBullheads}}</text>
          </view>
        </view>
      </view>

      <!-- å½“å‰å›åˆçŠ¶æ€æç¤º -->
      <view class="turn-status" wx:if="{{selectedCard}}">
        <text class="turn-status-text">å·²é€‰æ‹©ç‰Œï¼š<text class="selected-card-num">{{selectedCard}}</text></text>
        <text class="turn-status-hint">ç­‰å¾…æ‰€æœ‰äººå‡ºç‰ŒååŒæ—¶äº®ç‰Œ</text>
      </view>
    </view>
  </view>

  <!-- äº®ç‰Œå±•ç¤º -->
  <view class="reveal-section" wx:if="{{revealedCards.length > 0 || sortedCards}}">
    <view class="reveal-card">
      <view class="reveal-info">
        <text class="reveal-label">æœ¬å›åˆï¼š</text>
        <text class="reveal-badge">{{players.length}}äººå‚ä¸</text>
        <text class="reveal-badge sorted" wx:if="{{sortedCards}}">æ’åºï¼š{{sortedCards}}</text>
      </view>
      <view class="reveal-status">
        <text class="reveal-icon">â­</text>
        <text>ç­‰å¾…åˆ¤å®š</text>
      </view>
    </view>
  </view>

  <!-- æ‰‹ç‰ŒåŒº -->
  <view class="hand-section">
    <view class="hand-card">
      <view class="hand-header">
        <text class="hand-label">æˆ‘çš„æ‰‹ç‰Œï¼ˆå‰©ä½™<text class="hand-count">{{handCount}}</text>å¼ ï¼‰</text>
        <view class="hand-sort-hint">
          <text>å·²æŒ‰æ•°å­—å‡åºæ’åº</text>
          <text class="sort-icon">â†‘â†“</text>
        </view>
      </view>

      <scroll-view scroll-x class="hand-scroll">
        <view class="hand-cards">
          <view class="hand-card-item {{selectedCard === card.number ? 'selected' : ''}}" 
                wx:for="{{playerHand}}" 
                wx:for-item="card" 
                wx:key="number"
                bindtap="selectCard"
                data-card-number="{{card.number}}">
            <text wx:if="{{selectedCard === card.number}}" class="card-selected-label">å½“å‰é€‰æ‹©</text>
            <text class="hand-card-number">{{card.number}}</text>
            <text wx:if="{{card.bullheads > 0}}" class="hand-card-bullheads">{{card.bullheads}} ğŸ‚</text>
          </view>
        </view>
      </scroll-view>

      <view class="hand-actions">
        <button class="hosting-btn {{isHosting ? 'hosting-active' : ''}}" bindtap="handleToggleHosting">
          {{isHosting ? 'å–æ¶ˆæ‰˜ç®¡' : 'å¼€å¯æ‰˜ç®¡'}}
        </button>
        <button class="cancel-btn" bindtap="handleCancelSelect" disabled="{{!selectedCard}}">å–æ¶ˆé€‰æ‹©</button>
        <!-- äº¤äº’ä¼˜åŒ–ï¼šå…è®¸ç‚¹å‡»ï¼Œä½†åœ¨ JS é‡Œåš canPlay æ ¡éªŒå¹¶æç¤ºåŸå›  -->
        <button class="confirm-btn" bindtap="handlePlayCard" disabled="{{!selectedCard || isProcessing}}">
          {{isProcessing ? 'å‡ºç‰Œä¸­...' : 'ç¡®è®¤å‡ºç‰Œ'}}
        </button>
      </view>
    </view>
  </view>

  <!-- é€‰æ‹©æ”¶ç‰Œè¡Œå¼¹çª— -->
  <view class="select-row-modal" wx:if="{{showSelectRowModal}}">
    <view class="modal-mask" catchtap="handleCancelSelectRow"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">é€‰æ‹©è¦æ”¶å–çš„è¡Œ</text>
        <view class="modal-countdown">
          <text class="countdown-text">{{selectRowCountdown}}s</text>
          <text class="countdown-hint">è¶…æ—¶è‡ªåŠ¨é€‰æ‹©çŒªå¤´æœ€å°‘çš„è¡Œ</text>
        </view>
      </view>
      
      <view class="modal-body">
        <view class="select-row-list">
          <view class="select-row-item {{selectedRowIndex === index ? 'selected' : ''}}"
                wx:for="{{rows}}"
                wx:key="index"
                bindtap="handleSelectRow"
                data-row-index="{{index}}">
            <view class="select-row-header">
              <text class="select-row-number">ç¬¬ {{index + 1}} è¡Œ</text>
              <text class="select-row-bullheads">ğŸ‚ {{item.totalBullheads}} çŒªå¤´</text>
            </view>
            <view class="select-row-cards">
              <view class="select-row-card" 
                    wx:for="{{item.cards}}"
                    wx:for-item="card"
                    wx:key="number">
                <text class="card-num">{{card.number}}</text>
                <text class="card-bull" wx:if="{{card.bullheads > 0}}">{{card.bullheads}}ğŸ‚</text>
              </view>
            </view>
            <view class="select-row-check" wx:if="{{selectedRowIndex === index}}">
              <text class="check-icon">âœ“</text>
            </view>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn cancel-btn" bindtap="handleCancelSelectRow">å–æ¶ˆ</button>
        <button class="modal-btn confirm-btn" bindtap="handleConfirmSelectRow">ç¡®è®¤æ”¶å–</button>
      </view>
    </view>
  </view>
</view>
