<view class="container">
  <!-- Custom Header -->
  <view class="custom-header" style="padding-top: {{statusBarHeight}}px">
    <view class="header-content">
      <view class="room-tag" wx:if="{{roomId}}">æˆ¿é—´ #{{roomId}}</view>
      <view class="header-title">å¥½å‹å±€ Â· ç­‰å¾…å‡†å¤‡</view>
      <view class="exit-btn" bindtap="handleLeaveRoom" wx:if="{{roomId}}">
        <text class="arrow-left">â†</text> é€€å‡ºæˆ¿é—´
      </view>
    </view>
  </view>

  <!-- Empty State (No Room Joined) -->
  <view class="empty-state" wx:if="{{!roomId}}" style="margin-top: 200rpx; display: flex; flex-direction: column; align-items: center;">
     <text style="color: #8fa0c1; margin-bottom: 20rpx;">æ‚¨å°šæœªåŠ å…¥ä»»ä½•æˆ¿é—´</text>
     <navigator url="/pages/lobby/lobby" open-type="switchTab" style="background: #10b981; padding: 20rpx 40rpx; border-radius: 10rpx; color: white;">å‰å¾€å¤§å…</navigator>
  </view>

  <!-- Main Content -->
  <scroll-view scroll-y class="main-content" wx:if="{{roomId}}">
    <!-- Rules Card -->
    <view class="card rules-card">
      <view class="card-content">
        <view class="rules-info">
          <view class="rules-text">è§„åˆ™é…ç½®</view>
          <view class="rules-detail">{{ruleText}}</view>
          <view class="current-round">å½“å‰å±€ï¼šç¬¬ {{roomInfo.currentRound || 1}} å±€</view>
        </view>
        <view class="host-info">
          <view class="host-label">æˆ¿ä¸»</view>
          <view class="host-name">{{hostName}}</view>
        </view>
      </view>
    </view>

    <!-- Action Buttons (Moved above player list) -->
    <view class="action-buttons-section">
      <button class="action-btn secondary {{isMeReady ? 'active' : ''}}" bindtap="handleReady">
        {{isMeReady ? 'å–æ¶ˆå‡†å¤‡' : 'å‡†å¤‡'}}
      </button>

      <button class="action-btn primary {{canStartGame && isHost ? '' : 'disabled'}}" bindtap="handleStartGame" disabled="{{!canStartGame || !isHost}}">
        æˆ¿ä¸»å¼€å§‹æ¸¸æˆ
      </button>
    </view>

    <!-- Player List Card -->
    <view class="card players-card">
      <view class="card-header">
        <text class="card-title">ç©å®¶ ({{activePlayers}} / {{maxPlayers}})</text>
        <view class="header-actions" wx:if="{{isHost && activePlayers < maxPlayers}}">
           <picker bindchange="onBotCountChange" range="{{botCountRange}}">
             <view class="add-bot-btn">
               <text>+ æ·»åŠ ç”µè„‘</text>
             </view>
           </picker>
        </view>
      </view>

      <view class="players-grid compact">
        <block wx:for="{{playerSlots}}" wx:key="index">
          <!-- Occupied Slot -->
          <view class="player-slot occupied compact" wx:if="{{item.player}}">
            <view class="avatar-container small">
              <image class="avatar" src="{{item.player.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
              <view class="role-badge" wx:if="{{item.isHost}}">æˆ¿ä¸»</view>
              <view class="role-badge" wx:if="{{item.player.isRobot}}" style="background-color: #3b82f6;">AI</view>
              <view class="ready-badge" wx:if="{{item.player.isReady === true || (item.isHost && item.player.isReady !== false)}}">âœ“</view>
            </view>
            <view class="player-name compact">
              {{item.isMe ? 'æˆ‘' : item.player.nickname}}
            </view>
          </view>

          <!-- Empty Slot -->
          <view class="player-slot empty compact" wx:else>
            <view class="add-icon small">+</view>
            <view class="empty-text compact">ç­‰å¾…åŠ å…¥</view>
          </view>
        </block>
      </view>
    </view>

    <!-- Status Info (Moved between player list and action buttons) -->
    <view class="room-status-info">
       <text class="hint-text">æ‰€æœ‰ç©å®¶ç‚¹å‡»"å‡†å¤‡"åï¼Œæˆ¿ä¸»å¯å¼€å§‹æ¸¸æˆã€‚</text>
       <view class="ready-count">
         <text class="user-icon">ğŸ‘¤</text> {{readyCount}}/{{maxPlayers}} å·²å‡†å¤‡
       </view>
    </view>

    <!-- Chat Window Card -->
    <view class="card chat-card">
      <scroll-view scroll-y class="chat-list" scroll-into-view="msg-{{chatMessages.length-1}}">
        <block wx:for="{{chatMessages}}" wx:key="index">
          <view id="msg-{{index}}" class="chat-message {{item.isMe ? 'me' : 'other'}}">
             <view class="sender-name" wx:if="{{!item.isMe}}">{{item.sender}}</view>
             <view class="message-bubble">{{item.content}}</view>
          </view>
        </block>
        <view class="chat-placeholder" wx:if="{{chatMessages.length === 0}}">
          <text>æˆ¿é—´å†…çš„èŠå¤©è®°å½•</text>
        </view>
      </scroll-view>

      <view class="chat-input-area">
        <input class="chat-input" placeholder="å‘é€æ¶ˆæ¯..." value="{{inputValue}}" bindinput="onInput" confirm-type="send" bindconfirm="handleSendChat" />
        <view class="send-btn" bindtap="handleSendChat">å‘é€</view>
      </view>
    </view>

    <!-- Footer Actions (Room ID & Share) -->
    <view class="room-footer-actions">
       <view class="room-id-btn" bindtap="handleCopyRoomId">
         <text class="id-text">æˆ¿é—´å·: {{roomId}}</text>
         <image class="copy-icon-sm" src="/images/copy.png" mode="widthFix"></image>
       </view>

       <button class="share-btn compact" bindtap="handleShareRoom" open-type="share">
        <text class="wechat-icon">ğŸ’¬</text> å¾®ä¿¡é‚€è¯·
       </button>
    </view>
  </scroll-view>

</view>
