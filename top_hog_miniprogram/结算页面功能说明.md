# 结算页面功能说明

## 功能概述

结算页面展示本局游戏结果，包括：
1. **前三名玩家排行**：显示冠亚季军和猪头数
2. **完整排行榜**：显示所有玩家的本局得分
3. **累计积分**：显示所有玩家的总分
4. **再来一局**：继续下一局或返回大厅
5. **生成战绩海报**：Canvas生成精美海报，可保存和分享

---

## 1. 页面入口

### 从游戏页面跳转
```javascript
// pages/game/game.js
if (roomState.gameState === 'GAME_OVER' || roomState.gameState === 'FINISHED') {
  // 保存游戏结果
  app.globalData.gameResult = gameResult;
  wx.setStorageSync('gameResult', gameResult);
  
  // 跳转
  wx.redirectTo({
    url: `/pages/result/result?roomId=${roomId}&isGameOver=true`
  });
}
```

### 参数说明
- `roomId`：房间ID
- `isGameOver`：true=游戏彻底结束，false=单局结束还可继续

---

## 2. 数据结构

### gameResult 数据格式
```javascript
{
  roomId: 'A68F',
  roomName: '王先森的房间',
  currentRound: 3,              // 当前第几局
  maxRounds: 10,                // 总共多少局
  remainingRounds: 7,           // 剩余局数
  targetScore: 66,              // 目标分数（超过此分数游戏结束）
  players: {                    // 玩家对象
    'player1': {
      id: 'player1',
      displayName: '张三',
      avatarUrl: '/images/avatar.png',
      roundScore: 5,            // 本局得分
      totalScore: 23,           // 总分
      score: 23
    }
  },
  rankings: [...],              // 排行榜数组（已排序）
  isGameOver: false             // 是否游戏彻底结束
}
```

### rankings 数组格式
```javascript
[
  {
    id: 'player1',
    name: '张三',
    avatarUrl: '/images/avatar.png',
    score: 2,                   // 本局猪头数（越少越好）
    totalScore: 15,             // 总猪头数
    isMe: true                  // 是否是当前玩家
  },
  {
    id: 'player2',
    name: '李四',
    avatarUrl: '/images/avatar2.png',
    score: 5,
    totalScore: 23,
    isMe: false
  }
  // ... 按 score 升序排列
]
```

---

## 3. 前三名展示

### UI布局
```
        👑
       [冠军]
     张三 - 2🐂
     
[亚军]         [季军]
李四 - 5🐂     王五 - 9🐂
```

### 实现位置
- **WXML**：`pages/result/result.wxml` 第30-54行
- **WXSS**：`pages/result/result.wxss` 第115-195行

### 关键样式
```css
.podium {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 16rpx;
  align-items: flex-end;
}

.podium-item.first {
  order: 2;  /* 冠军在中间 */
}

.podium-avatar.champion {
  width: 112rpx;
  height: 112rpx;
  border-color: #fbbf24;  /* 金色边框 */
  box-shadow: 0 8rpx 16rpx rgba(251, 191, 36, 0.4);
}

.crown-icon {
  position: absolute;
  top: -8rpx;
  right: -8rpx;
  font-size: 32rpx;
}
```

---

## 4. 再来一局功能

### 两种情况

#### 4.1 单局结束（isGameOver = false）
```javascript
handlePlayAgain() {
  // 清空结算数据
  app.globalData.gameResult = null;
  wx.removeStorageSync('gameResult');
  
  // 跳转回游戏页面继续下一局
  wx.redirectTo({
    url: `/pages/game/game?roomId=${this.data.roomId}`
  });
}
```

#### 4.2 游戏彻底结束（isGameOver = true）
```javascript
handlePlayAgain() {
  wx.showModal({
    title: '提示',
    content: '本局游戏已结束，是否返回大厅开始新游戏？',
    confirmText: '返回大厅',
    success: (res) => {
      if (res.confirm) {
        wx.switchTab({
          url: '/pages/lobby/lobby'
        });
      }
    }
  });
}
```

### 后端需求
- 单局结束时，后端应推送 `gameState: 'ROUND_END'`
- 游戏彻底结束时，后端应推送 `gameState: 'GAME_OVER'` 或 `'FINISHED'`
- 再来一局时，后端应重置房间状态，准备下一局

---

## 5. 生成战绩海报

### 海报内容
1. **顶部**：游戏标题 + 房间名 + 第几局
2. **中部**：🏆 奖杯图标
3. **前三名**：冠亚季军名称和分数
4. **排行榜**：完整玩家列表
5. **底部**：二维码提示

### 实现流程

#### 5.1 点击生成海报
```javascript
handleShare() {
  wx.showLoading({ title: '生成海报中...' });
  this.generatePoster();
}
```

#### 5.2 使用 Canvas 2D 生成
```javascript
generatePoster() {
  const query = wx.createSelectorQuery();
  query.select('#posterCanvas')
    .fields({ node: true, size: true })
    .exec((res) => {
      const canvas = res[0].node;
      const ctx = canvas.getContext('2d');
      
      // 设置分辨率
      const dpr = wx.getSystemInfoSync().pixelRatio;
      canvas.width = 375 * dpr;
      canvas.height = 667 * dpr;
      ctx.scale(dpr, dpr);
      
      // 绘制内容
      this.drawPoster(ctx, canvas);
    });
}
```

#### 5.3 绘制海报内容
```javascript
drawPoster(ctx, canvas) {
  // 1. 背景渐变
  const gradient = ctx.createLinearGradient(0, 0, 0, 667);
  gradient.addColorStop(0, '#0f172a');
  gradient.addColorStop(1, '#1e293b');
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, 375, 667);
  
  // 2. 标题
  ctx.fillStyle = '#10b981';
  ctx.font = 'bold 16px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('top_hog 游戏战绩', 187.5, 40);
  
  // 3. 奖杯图标
  ctx.font = '48px sans-serif';
  ctx.fillText('🏆', 187.5, 130);
  
  // 4. 前三名
  // ...
  
  // 5. 排行榜
  // ...
  
  // 6. 生成图片
  wx.canvasToTempFilePath({
    canvas: canvas,
    success: (res) => {
      this.setData({
        showPoster: true,
        posterPath: res.tempFilePath
      });
    }
  });
}
```

#### 5.4 显示海报弹窗
```xml
<view class="poster-modal" wx:if="{{showPoster}}">
  <view class="poster-mask" catchtap="handleClosePoster"></view>
  <view class="poster-content">
    <image class="poster-image" src="{{posterPath}}"></image>
    <view class="poster-actions">
      <button catchtap="handleSavePoster">保存到相册</button>
      <button open-type="share">分享给好友</button>
    </view>
  </view>
</view>
```

#### 5.5 保存到相册
```javascript
handleSavePoster() {
  wx.saveImageToPhotosAlbum({
    filePath: this.data.posterPath,
    success: () => {
      wx.showToast({ title: '已保存到相册', icon: 'success' });
    },
    fail: (err) => {
      if (err.errMsg.indexOf('auth') !== -1) {
        // 需要授权
        wx.showModal({
          title: '提示',
          content: '需要您授权保存图片到相册',
          confirmText: '去授权',
          success: (res) => {
            if (res.confirm) {
              wx.openSetting();
            }
          }
        });
      }
    }
  });
}
```

#### 5.6 分享给好友
```javascript
onShareAppMessage() {
  const myRanking = this.data.rankings.findIndex(r => r.isMe) + 1;
  return {
    title: `我在 top_hog 第${this.data.currentRound}局获得第${myRanking}名！`,
    path: `/pages/lobby/lobby`,
    imageUrl: this.data.posterPath || '/images/share-result.jpg'
  };
}
```

---

## 6. 样式设计

### 主题色
- **背景**：深色渐变 `#0f172a` → `#1e293b`
- **主色调**：绿色 `#10b981`（成功、胜利）
- **金色**：`#fbbf24`（冠军、重点）
- **灰色**：`#94a3b8`（次要信息）

### 卡片设计
- **圆角**：32-48rpx
- **边框**：1rpx，半透明绿色/灰色
- **阴影**：`box-shadow: 0 8rpx 32rpx rgba(16, 185, 129, 0.3)`
- **背景**：半透明 `rgba(30, 41, 59, 0.9)`

### 动画
- **海报弹窗**：`posterSlideIn`（缩放+位移）
- **持续时间**：0.3秒
- **缓动函数**：`ease-out`

---

## 7. 关键代码位置

### JavaScript (pages/result/result.js)
- **数据加载**：第36-117行 `loadResult()`
- **再来一局**：第124-153行 `handlePlayAgain()`
- **生成海报**：第155-192行 `generatePoster()`
- **绘制海报**：第194-282行 `drawPoster()`
- **保存海报**：第289-311行 `handleSavePoster()`

### WXML (pages/result/result.wxml)
- **前三名**：第30-54行
- **排行榜**：第57-63行
- **操作按钮**：第83-97行
- **海报弹窗**：第100-120行
- **Canvas**：第123-127行

### WXSS (pages/result/result.wxss)
- **领奖台样式**：第115-195行
- **海报弹窗样式**：第331-434行

---

## 8. 测试要点

### 8.1 数据展示
- ✅ 前三名玩家正确显示
- ✅ 排行榜按猪头数升序排列
- ✅ 当前玩家高亮显示
- ✅ 剩余局数正确计算

### 8.2 再来一局
- ✅ 单局结束时，跳转回游戏页面
- ✅ 游戏结束时，提示返回大厅
- ✅ 数据正确清空和重置

### 8.3 生成海报
- ✅ Canvas 正确绘制内容
- ✅ 海报图片清晰无失真
- ✅ 保存到相册功能正常
- ✅ 分享给好友功能正常
- ✅ 权限申请提示正确

### 8.4 边界情况
- ✅ 玩家数少于3人时布局正常
- ✅ 玩家名称过长时正确截断
- ✅ 没有游戏结果时使用模拟数据
- ✅ 分享时正确携带海报图片

---

## 9. 后端对接要点

### 9.1 推送游戏结束消息
```javascript
{
  type: 'roomStateUpdate',
  roomState: {
    gameState: 'GAME_OVER',  // 或 'ROUND_END' / 'FINISHED'
    currentRound: 3,
    maxRounds: 10,
    targetScore: 66,
    players: {
      'player1': {
        id: 'player1',
        displayName: '张三',
        roundScore: 5,       // 本局得分
        totalScore: 23,      // 总分
        score: 23
      }
    }
  }
}
```

### 9.2 游戏状态枚举
- `WAITING`：等待中
- `READY`：准备中
- `PLAYING`：游戏中
- `ROUND_END`：单局结束（可继续）
- `GAME_OVER` / `FINISHED`：游戏彻底结束

### 9.3 数据计算
- **roundScore**：本局玩家吃到的猪头数
- **totalScore**：所有局累计的猪头数
- **rankings**：按 roundScore 升序排列
- **isGameOver**：任意玩家 totalScore >= targetScore

---

## 10. 后续优化建议

1. **历史战绩**：查看过往所有局的详细数据
2. **数据统计**：胜率、平均得分、最佳排名等
3. **成就系统**：连胜、低分记录、特殊牌型等
4. **动画效果**：排行榜滚动、分数跳动
5. **音效**：胜利音效、掌声
6. **海报美化**：增加装饰元素、二维码
7. **社交功能**：邀请好友、创建战队
8. **排行榜**：全服排行、好友排行

---

## 11. 性能优化

1. **Canvas 优化**：使用离屏Canvas提升绘制性能
2. **图片压缩**：生成海报时适当降低质量
3. **懒加载**：海报在需要时才生成
4. **缓存策略**：海报生成后缓存，避免重复绘制
5. **内存管理**：Canvas绘制完成后及时释放

---

## 总结

结算页面功能完整，包括：
- ✅ **前三名展示**：精美的领奖台布局
- ✅ **完整排行榜**：所有玩家得分
- ✅ **再来一局**：智能判断游戏状态
- ✅ **生成海报**：Canvas高质量绘制
- ✅ **保存分享**：相册保存+好友分享

所有功能已实现并优化，提供优秀的用户体验！🎉

