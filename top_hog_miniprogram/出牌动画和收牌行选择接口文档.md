# 出牌动画和收牌行选择接口文档

## 1. 出牌动画功能

### 前端实现
- **触发时机**：当 WebSocket 推送 `playedCardsThisTurn` 数据且本地没有正在播放动画时
- **动画逻辑**：
  1. 将所有已出的牌按**数字从小到大**排序
  2. 每张牌依次显示，间隔 **600ms**
  3. 每张牌飞入时有**缩放+旋转**的动画效果（持续500ms）
  4. 所有牌显示完成后保留 **3秒**，然后清空

### 数据结构
```javascript
// WebSocket 推送的数据结构
{
  type: 'roomStateUpdate',
  roomState: {
    playedCardsThisTurn: {
      'player1': { cardNumber: 45, bullheads: 5, playerName: '张三' },
      'player2': { cardNumber: 67, bullheads: 1, playerName: '李四' },
      // ...
    }
  }
}
```

### UI 展示
- 半透明深色背景，蓝色边框
- 卡牌从上方飞入，带旋转效果
- 每张卡片显示：卡牌数字、猪头数、玩家名称

---

## 2. 选择收牌行功能

### 业务场景
当玩家出的牌**无法放置到任何一行**时（牌的数字比所有行的最后一张牌都小），需要：
1. 服务器推送 `needSelectRow` 消息
2. 前端弹出选择收牌行的弹窗
3. 玩家必须选择一行来收取（吃掉该行所有牌的猪头数）
4. 30秒倒计时，超时自动选择**猪头数最少**的行

### WebSocket 消息

#### 2.1 服务器推送：需要选择收牌行
```javascript
{
  type: 'needSelectRow', // 或 'selectRow'
  data: {
    playerId: 'player1',
    cardNumber: 23, // 无法放置的牌
    reason: '该牌比所有行的最后一张牌都小'
  }
}
```

**前端处理**：
- 调用 `showSelectRowDialog()` 显示弹窗
- 开始 30 秒倒计时
- 倒计时结束调用 `autoSelectMinBullheadsRow()` 自动选择

#### 2.2 玩家选择收牌行（前端发送）
```javascript
{
  type: 'selectRow',
  roomId: 'A68F',
  rowIndex: 2, // 0-3，表示第1-4行
  userIdentifier: 'player1' // 可选，用于验证
}
```

#### 2.3 服务器确认收牌行已选择
```javascript
{
  type: 'rowSelected',
  data: {
    playerId: 'player1',
    rowIndex: 2,
    collectedBullheads: 8, // 收取的猪头数
    newRow: {
      cards: [{ number: 23, bullheads: 1 }] // 新行的初始牌
    }
  }
}
```

**前端处理**：
- 关闭弹窗
- 显示提示："收牌成功"
- 等待服务器推送新的 `roomStateUpdate` 来更新场牌

---

## 3. 场牌布局规则

### 显示规则
- **每行最多显示 6 张牌**（前端强制限制 `slice(0, 6)`）
- **第 1 张牌**：绿色边框，标签"排头"
- **第 5 张牌**：橙色边框+阴影，标签"第5张"
- **第 6 张牌（如果有）**：红色边框，标签"已5张·再接即吃猪"

### 数据结构
```javascript
rows: [
  {
    cards: [
      { number: 12, bullheads: 1, isHead: true, isFifth: false, isDanger: false },
      { number: 34, bullheads: 2, isHead: false, isFifth: false, isDanger: false },
      { number: 45, bullheads: 5, isHead: false, isFifth: false, isDanger: false },
      { number: 56, bullheads: 1, isHead: false, isFifth: false, isDanger: false },
      { number: 67, bullheads: 1, isHead: false, isFifth: true, isDanger: false }, // 第5张
      { number: 78, bullheads: 3, isHead: false, isFifth: false, isDanger: true }  // 第6张（危险）
    ],
    totalBullheads: 13,
    isDanger: true
  }
  // ... 其他行
]
```

---

## 4. 后端开发要点

### 4.1 判断是否需要选择收牌行
```javascript
// 伪代码
function needSelectRow(card, rows) {
  for (let row of rows) {
    const lastCard = row.cards[row.cards.length - 1];
    if (card.number > lastCard.number) {
      return false; // 可以放置到该行
    }
  }
  return true; // 无法放置到任何一行
}
```

### 4.2 推送选择通知
```javascript
if (needSelectRow(playedCard, gameState.rows)) {
  sendWebSocketMessage({
    type: 'needSelectRow',
    data: {
      playerId: player.id,
      cardNumber: playedCard.number
    }
  });
}
```

### 4.3 处理玩家选择
```javascript
// 监听 selectRow 消息
onMessage('selectRow', (message) => {
  const { roomId, rowIndex } = message;
  const row = gameState.rows[rowIndex];
  
  // 计算收取的猪头数
  const collectedBullheads = row.cards.reduce((sum, card) => sum + card.bullheads, 0);
  
  // 更新玩家分数
  player.score += collectedBullheads;
  
  // 清空该行，放入玩家的新牌
  gameState.rows[rowIndex] = {
    cards: [playedCard]
  };
  
  // 推送更新
  broadcastRoomState(roomId);
  
  // 确认消息
  sendWebSocketMessage({
    type: 'rowSelected',
    data: {
      playerId: player.id,
      rowIndex: rowIndex,
      collectedBullheads: collectedBullheads
    }
  });
});
```

### 4.4 超时处理（可选）
如果后端也要实现超时自动选择：
```javascript
// 设置30秒定时器
const timer = setTimeout(() => {
  // 找出猪头数最少的行
  let minBullheads = Infinity;
  let minRowIndex = 0;
  
  gameState.rows.forEach((row, index) => {
    const bullheads = row.cards.reduce((sum, card) => sum + card.bullheads, 0);
    if (bullheads < minBullheads) {
      minBullheads = bullheads;
      minRowIndex = index;
    }
  });
  
  // 自动选择
  handleSelectRow(player, minRowIndex);
}, 30000);

// 玩家手动选择时清除定时器
clearTimeout(timer);
```

---

## 5. 前端测试要点

### 5.1 出牌动画测试
1. ✅ 动画按数字从小到大依次显示
2. ✅ 每张牌飞入效果流畅
3. ✅ 显示完成后保留3秒再消失
4. ✅ 不会与其他UI元素冲突

### 5.2 选择收牌行测试
1. ✅ 弹窗正确显示所有行的牌和猪头数
2. ✅ 30秒倒计时正常工作
3. ✅ 选择行后高亮显示
4. ✅ 点击"确认收取"成功发送消息
5. ✅ 倒计时结束自动选择猪头数最少的行
6. ✅ 如果多行猪头数相同，选择第一行

### 5.3 场牌布局测试
1. ✅ 第1张牌绿色边框，显示"排头"
2. ✅ 第5张牌橙色边框+阴影，显示"第5张"
3. ✅ 第6张牌红色边框，显示危险提示
4. ✅ 每行最多显示6张牌

---

## 6. 注意事项

1. **前端主动防御**：即使后端返回超过6张牌，前端也只显示前6张
2. **倒计时同步**：前端30秒倒计时是本地的，后端如果也实现超时，需要确保时间一致
3. **动画性能**：出牌动画使用CSS动画，性能较好，但卡牌数量超过10张时可能需要优化
4. **网络延迟**：选择收牌行时，如果网络延迟导致消息未及时发送，前端会在倒计时结束时自动选择
5. **并发处理**：如果多个玩家同时需要选择收牌行（理论上不会），后端需要处理队列

---

## 7. 后续优化建议

1. **音效**：出牌动画播放卡牌翻转音效
2. **震动反馈**：选择收牌行时震动提醒
3. **动画优化**：出牌动画支持更多玩家（当前最多显示10张左右）
4. **自动对焦**：选择收牌行弹窗时，自动滚动到猪头数最少的行
5. **历史记录**：记录每次选择收牌行的历史，供玩家查看

